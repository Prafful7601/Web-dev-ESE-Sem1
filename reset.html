<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Reset Password</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; color:#333; margin:40px; }
    .card { max-width:420px; margin:20px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
    h2 { margin:0 0 12px; color:#2a0f6d; }
    label { display:block; margin:8px 0 4px; font-size:14px; }
    input { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; }
    button { background:#2a0f6d; color:#fff; padding:10px 14px; border:0; border-radius:8px; cursor:pointer; margin-top:12px; }
    .status { margin-top:10px; min-height:18px; font-size:14px; }
    .ok { color:green; } .err { color:#c00; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Set a new password</h2>
    <div id="tokenInfo" style="font-size:13px; color:#555; margin-bottom:8px;"></div>
    <label>New password</label>
    <input id="newPass" type="password" placeholder="At least 6 characters">
    <button id="saveBtn">Update Password</button>
    <div id="status" class="status"></div>
  </div>

  <script>
  const API = "http://localhost:4000/api";
  const $ = id => document.getElementById(id);

  // read token from URL
  const params = new URLSearchParams(location.search);
  const token = params.get("token") || "";

  function setStatus(msg, ok) {
    $("status").textContent = msg || "";
    $("status").className = "status " + (ok ? "ok" : "err");
  }

  async function verifyToken() {
    if (!token) {
      $("saveBtn").disabled = true;
      $("tokenInfo").textContent = "No token in URL";
      setStatus("Missing token in URL", false);
      return false;
    }
    try {
      const res = await fetch(`${API}/auth/verify-reset?token=${encodeURIComponent(token)}`);
      if (!res.ok) {
        $("saveBtn").disabled = true;
        $("tokenInfo").textContent = "Token invalid or expired";
        setStatus("Invalid or expired link", false);
        return false;
      }
      $("tokenInfo").textContent = "Reset link verified";
      setStatus("", true);
      $("saveBtn").disabled = false;
      return true;
    } catch {
      $("saveBtn").disabled = true;
      setStatus("Network error while verifying", false);
      return false;
    }
  }

  async function handleSave() {
    const newPassword = $("newPass").value.trim();
    if (!newPassword || newPassword.length < 6) {
      return setStatus("Password must be at least 6 characters", false);
    }
    if (!(await verifyToken())) return;

    $("saveBtn").disabled = true;
    setStatus("Updating password...", true);
    try {
      const res = await fetch(`${API}/auth/reset`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token, newPassword })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        return setStatus(data.error || "Could not reset password", false);
      }
      setStatus("Password updated. Redirecting to login...", true);
      setTimeout(() => { location.href = `${location.origin}/auth.html`; }, 800);
    } catch {
      setStatus("Network error. Try again.", false);
    } finally {
      $("saveBtn").disabled = false;
    }
  }

  // submit with button or Enter
  $("saveBtn").addEventListener("click", handleSave);
  $("newPass").addEventListener("keydown", e => {
    if (e.key === "Enter") handleSave();
  });

  // optional show or hide password
  // add a checkbox with id="togglePass" if you want to use this
  const toggle = $("togglePass");
  if (toggle) {
    toggle.addEventListener("change", () => {
      $("newPass").type = toggle.checked ? "text" : "password";
    });
  }

  // verify on load
  $("saveBtn").disabled = true;
  $("tokenInfo").textContent = token ? "Checking link..." : "No token in URL";
  verifyToken();
</script>

</body>
</html>
